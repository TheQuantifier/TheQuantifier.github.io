<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blog – The Quantifier</title>

  <meta name="description" content="The Quantifier blog — math, code, and thoughts." />
  <meta name="author" content="John Hand" />

  <link rel="icon" type="image/png" href="images/favicon.png" />
  <link rel="stylesheet" href="styles/default.css" />
  <link rel="stylesheet" href="styles/blog.css" />
</head>
<body>
  <!-- ==================== HEADER ==================== -->
  <header>
    <div class="container">
      <h1 class="site-title">The Quantifier</h1>
      <p class="tagline">Math • Code • Game • Repeat</p>
      <nav aria-label="Main Navigation">
        <ul class="nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="blog.html" class="active">Blog</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- ==================== MAIN ==================== -->
  <main class="container">
    <section class="hero">
      <h2>Blog</h2>
      <p>Notes on mathematics, programming projects, and occasional philosophy.</p>
    </section>

    <!-- Controls -->
    <section class="blog-controls" aria-label="Blog controls">
      <label for="blog-search" class="visually-hidden">Search posts by title</label>
      <input id="blog-search" type="search" placeholder="Search by title…" autocomplete="off" />
      <div class="blog-meta">
        <span id="results-count" aria-live="polite"></span>
      </div>
    </section>

    <!-- Posts -->
    <section id="blog" class="blog-grid" aria-live="polite" aria-busy="true">
      <!-- Cards injected here -->
    </section>

    <!-- Load more -->
    <div class="load-more-wrap">
      <button id="load-more" class="button" type="button">Load more</button>
    </div>

    <div id="blog-error" class="blog-error" hidden>
      <p>Couldn’t load posts. Please refresh.</p>
    </div>
  </main>

  <!-- ==================== FOOTER ==================== -->
  <footer>
    <div class="container footer-content">
      <p>&copy; <span id="year"></span> The Quantifier. All rights reserved.</p>
      <p class="credit">Site by <strong>Manus Webworks</strong></p>
    </div>
  </footer>

  <script>
    // -------- Utilities --------
    const PAGE_SIZE = 6;

    const $ = (sel) => document.querySelector(sel);

    function nl2br(str) {
      return (str || "").replace(/\n/g, "<br>");
    }

    function formatDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      } catch {
        return iso;
      }
    }

    // Images: centered/no distortion (CSS handles sizing)
    // + click-to-enlarge via lightbox
    function renderImages(images) {
      if (!Array.isArray(images) || images.length === 0) return "";
      return `
        <div class="post-images">
          ${images.map(src => `
            <figure>
              <img
                loading="lazy"
                src="images/blog/${src}"
                alt=""
                onclick="openLightbox('images/blog/${src}')"
              />
            </figure>
          `).join("")}
        </div>
      `;
    }

    function renderPost(post) {
      const title = (post.title || "Untitled");
      const messageHTML = nl2br(post.message); // supports <a> and <br> from JSON
      const dateShown = post.displayDate || formatDate(post.date);

      return `
        <article class="post-card" tabindex="0">
          <header class="post-header">
            <h3 class="post-title">${title}</h3>
            <time class="post-date" datetime="${post.date || ""}">${dateShown}</time>
          </header>
          <div class="post-body">
            <p>${messageHTML}</p>
            ${renderImages(post.images)}
          </div>
        </article>
      `;
    }

    // -------- Lightbox --------
    function openLightbox(src) {
      const overlay = document.createElement("div");
      overlay.className = "lightbox-overlay";
      overlay.innerHTML = `
        <div class="lightbox-content" role="dialog" aria-modal="true">
          <img src="${src}" alt="">
        </div>
      `;
      // Close on click anywhere
      overlay.addEventListener("click", () => {
        if (document.body.contains(overlay)) document.body.removeChild(overlay);
      });
      // Close on Escape key
      const onKey = (e) => {
        if (e.key === "Escape") {
          if (document.body.contains(overlay)) document.body.removeChild(overlay);
          document.removeEventListener("keydown", onKey);
        }
      };
      document.addEventListener("keydown", onKey);
      document.body.appendChild(overlay);
    }

    // -------- App State --------
    let allPosts = [];
    let filtered = [];
    let shownCount = 0;

    function updateResultsCount() {
      const el = $("#results-count");
      el.textContent = filtered.length
        ? `${Math.min(shownCount, filtered.length)} of ${filtered.length} posts`
        : "No posts found";
    }

    function renderNextPage() {
      const blogEl = $("#blog");
      const slice = filtered.slice(shownCount, shownCount + PAGE_SIZE);
      blogEl.insertAdjacentHTML("beforeend", slice.map(renderPost).join(""));
      shownCount += slice.length;

      // Hide or show Load More
      $("#load-more").style.display = (shownCount >= filtered.length) ? "none" : "inline-block";

      // Accessibility nicety
      blogEl.setAttribute("aria-busy", "false");
      updateResultsCount();
    }

    function resetAndRender() {
      $("#blog").innerHTML = "";
      shownCount = 0;
      renderNextPage();
    }

    function applyFilter(query) {
      const q = (query || "").trim().toLowerCase();
      if (!q) {
        filtered = [...allPosts];
      } else {
        filtered = allPosts.filter(p => (p.title || "").toLowerCase().includes(q));
      }
      resetAndRender();
    }

    async function loadBlog() {
      const errorEl = $("#blog-error");

      try {
        const res = await fetch("data/blog.json", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        allPosts = Array.isArray(data.posts) ? data.posts : [];
        // Sort latest-first by ISO date (fallback to 0 if invalid)
        allPosts.sort((a, b) => (new Date(b.date || 0)) - (new Date(a.date || 0)));

        filtered = [...allPosts];
        resetAndRender();
      } catch (e) {
        errorEl.hidden = false;
        console.error("Blog load failed:", e);
      }
    }

    // -------- Events --------
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('year').textContent = new Date().getFullYear();

      // Search (with small debounce)
      const searchInput = $("#blog-search");
      let t = null;
      searchInput.addEventListener("input", () => {
        clearTimeout(t);
        $("#blog").setAttribute("aria-busy", "true");
        t = setTimeout(() => applyFilter(searchInput.value), 180);
      });

      // Load more
      $("#load-more").addEventListener("click", () => {
        $("#blog").setAttribute("aria-busy", "true");
        renderNextPage();
      });

      loadBlog();
    });
  </script>
</body>
</html>