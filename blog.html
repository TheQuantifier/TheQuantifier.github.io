<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blog – The Quantifier</title>

  <meta name="description" content="The Quantifier Blog — exploring mathematics, programming, and gaming." />
  <meta name="author" content="John Hand" />

  <link rel="icon" type="image/png" href="images/favicon.png" />
  <link rel="stylesheet" href="styles/default.css" />
  <link rel="stylesheet" href="styles/blog.css" />
</head>
<script>
  (function () {
    const DURATION = 100; // keep in sync with --fade-duration

    // Mark page as ready (fade in)
    function ready() {
      // In case we returned from bfcache, remove fading state
      document.body.classList.remove('is-fading');
      document.body.classList.add('is-ready');
    }

    // On normal load & bfcache restore
    window.addEventListener('DOMContentLoaded', ready);
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) ready();
    });

    // Only intercept safe, same-tab, same-origin links
    function shouldIntercept(a) {
      if (!a) return false;
      const url = new URL(a.href, location.href);
      if (url.origin !== location.origin) return false;    // external
      if (a.target && a.target !== '_self') return false;  // new tab/window
      if (a.hasAttribute('download')) return false;        // download
      if (a.getAttribute('href')?.startsWith('#')) return false; // in-page
      return true;
    }

    document.addEventListener('click', (e) => {
      const a = e.target.closest('a');
      if (!shouldIntercept(a)) return;

      // Respect reduced motion
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      e.preventDefault();
      if (!prefersReduced) {
        document.body.classList.add('is-fading');
        setTimeout(() => (location.href = a.href), DURATION);
      } else {
        location.href = a.href;
      }
    });
  })();
</script>
<body>
  <!-- ==================== HEADER ==================== -->
  <header class="thin-header">
    <div class="header-bar">
      <div class="header-left">
        <h1 class="site-title">The Quantifier</h1>
        <span class="tagline">Math • Code • Game • Repeat</span>
      </div>

      <nav aria-label="Main Navigation">
        <ul class="nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="blog.html" class="active">Blog</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- ==================== BANNER ==================== -->
  <section class="banner">
    <img src="images/blog-banner.jpg" alt="Abstract geometric banner for The Quantifier Blog" />
    <div class="banner-overlay">
      <h2>The Quantifier Blog</h2>
      <p>Exploring mathematics, programming, and gaming — where logic meets creativity.</p>
    </div>
  </section>

  <!-- ==================== MAIN ==================== -->
  <main class="container">
    <section class="hero">
      <h2>Latest Posts</h2>
      <p>Notes on mathematics, Godot development, and gaming — from theory to creation.</p>
    </section>

    <!-- Controls -->
    <section class="blog-controls" aria-label="Blog controls">
      <label for="blog-search" class="visually-hidden">Search posts by title</label>
      <input id="blog-search" type="search" placeholder="Search by title…" autocomplete="off" />
      <div class="blog-meta">
        <span id="results-count" aria-live="polite"></span>
      </div>
    </section>

    <!-- Posts -->
    <section id="blog" class="blog-grid" aria-live="polite" aria-busy="true">
      <!-- Blog posts will load here dynamically -->
    </section>

    <!-- Load more -->
    <div class="load-more-wrap">
      <button id="load-more" class="button" type="button">Load more</button>
    </div>

    <!-- Error -->
    <div id="blog-error" class="blog-error" hidden>
      <p>Couldn’t load posts. Please refresh.</p>
    </div>
  </main>

  <!-- ==================== FOOTER ==================== -->
  <footer>
    <div class="container footer-content">
      <p>&copy; <span id="year"></span> The Quantifier. All rights reserved.</p>
      <p class="credit">Site by <strong>Manus Webworks</strong></p>
    </div>
  </footer>

  <!-- ==================== SCRIPTS ==================== -->
  <script>
    const PAGE_SIZE = 6;
    const $ = (sel) => document.querySelector(sel);

    function nl2br(str) {
      return (str || "").replace(/\n/g, "<br>");
    }

    function formatDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      } catch {
        return iso;
      }
    }

    function renderImages(images) {
      if (!Array.isArray(images) || images.length === 0) return "";
      return `
        <div class="post-images">
          ${images.map(src => `
            <figure>
              <img
                loading="lazy"
                src="images/blog/${src}"
                alt=""
                onclick="openLightbox('images/blog/${src}')"
              />
            </figure>
          `).join("")}
        </div>
      `;
    }

    function renderPost(post) {
      const title = post.title || "Untitled";
      const messageHTML = nl2br(post.message);
      const dateShown = post.displayDate || formatDate(post.date);

      return `
        <article class="post-card" tabindex="0">
          <header class="post-header">
            <h3 class="post-title">${title}</h3>
            <time class="post-date" datetime="${post.date || ""}">${dateShown}</time>
          </header>
          <div class="post-body">
            <p>${messageHTML}</p>
            ${renderImages(post.images)}
          </div>
        </article>
      `;
    }

    // -------- Lightbox --------
    function openLightbox(src) {
      const overlay = document.createElement("div");
      overlay.className = "lightbox-overlay";
      overlay.innerHTML = `
        <div class="lightbox-content" role="dialog" aria-modal="true">
          <img src="${src}" alt="">
        </div>
      `;
      overlay.addEventListener("click", () => document.body.removeChild(overlay));
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && document.body.contains(overlay)) {
          document.body.removeChild(overlay);
        }
      });
      document.body.appendChild(overlay);
    }

    // -------- Blog Logic --------
    let allPosts = [];
    let filtered = [];
    let shownCount = 0;

    function updateResultsCount() {
      const el = $("#results-count");
      el.textContent = filtered.length
        ? `${Math.min(shownCount, filtered.length)} of ${filtered.length} posts`
        : "No posts found";
    }

    function renderNextPage() {
      const blogEl = $("#blog");
      const slice = filtered.slice(shownCount, shownCount + PAGE_SIZE);
      blogEl.insertAdjacentHTML("beforeend", slice.map(renderPost).join(""));
      shownCount += slice.length;
      $("#load-more").style.display = (shownCount >= filtered.length) ? "none" : "inline-block";
      blogEl.setAttribute("aria-busy", "false");
      updateResultsCount();
    }

    function resetAndRender() {
      $("#blog").innerHTML = "";
      shownCount = 0;
      renderNextPage();
    }

    function applyFilter(query) {
      const q = (query || "").trim().toLowerCase();
      filtered = !q ? [...allPosts] : allPosts.filter(p => (p.title || "").toLowerCase().includes(q));
      resetAndRender();
    }

    async function loadBlog() {
      const errorEl = $("#blog-error");
      try {
        const res = await fetch("data/blog.json", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        allPosts = Array.isArray(data.posts) ? data.posts : [];
        allPosts.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
        filtered = [...allPosts];
        resetAndRender();
      } catch (e) {
        errorEl.hidden = false;
        console.error("Blog load failed:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      $("#year").textContent = new Date().getFullYear();
      const searchInput = $("#blog-search");
      let t = null;
      searchInput.addEventListener("input", () => {
        clearTimeout(t);
        $("#blog").setAttribute("aria-busy", "true");
        t = setTimeout(() => applyFilter(searchInput.value), 180);
      });
      $("#load-more").addEventListener("click", () => {
        $("#blog").setAttribute("aria-busy", "true");
        renderNextPage();
      });
      loadBlog();
    });
  </script>
</body>
</html>